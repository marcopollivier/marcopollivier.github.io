<!DOCTYPE html>
<html lang="pt-br">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">

    

    <meta name="author" content="Marco Ollivier">
    <meta name="description" content="Versionando seu Banco de Dados com Liquibase">
    <meta name="keywords" content="blog,developer,personal,software engineer ">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Versionando seu Banco de Dados com Liquibase"/>
<meta name="twitter:description" content="Versionando seu Banco de Dados com Liquibase"/>

    <meta property="og:title" content="Versionando seu Banco de Dados com Liquibase" />
<meta property="og:description" content="Versionando seu Banco de Dados com Liquibase" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://marcopollivier.dev/blog/versionando-banco-de-dados-com-liquibase/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2018-01-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-01-27T00:00:00+00:00" />




    <title>
  Versionando seu Banco de Dados com Liquibase ¬∑ Marco Ollivier
</title>

    
      <link rel="canonical" href="https://marcopollivier.dev/blog/versionando-banco-de-dados-com-liquibase/">
    

    <link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>

    
      
      
      <link rel="stylesheet" href="/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css" integrity="sha256-2f3b/&#43;byfmmYXcX&#43;BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css" integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin="anonymous" media="screen" />
      
    

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    <meta name="generator" content="Hugo 0.111.3">
  </head>

  
  
    
  
  <body class="preload-transitions colorscheme-auto">
    
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      Marco Ollivier
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/about/">Sobre</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/blog/">Blog</a>
            </li>
          
        
        
          
          
          
            
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="https://marcopollivier.dev/en/">üá¨üáß</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1 class="title">
        <a class="title-link" href="https://marcopollivier.dev/blog/versionando-banco-de-dados-com-liquibase/">
          Versionando seu Banco de Dados com Liquibase
        </a>
      </h1>
    </header>

    <p>Definitivamente o Liquibase n√£o √© uma novidade, mas sempre que ele torna minha vida mais f√°cil com a cria√ß√£o da estrutura dos meus bancos de dados relacionais ‚Äî especialmente no ambiente de desenvolvimento ‚Äî , fico com vontade de falar sobre ele para todo mundo. Ent√£o n√£o preciso dizer que j√° faz um tempo consider√°vel que me devo escrever sobre o assunto.</p>
<p><img src="https://miro.medium.com/v2/format:webp/1*SVQG8pR69GNPquRfJiazZw.jpeg" alt="liquibase"></p>
<h2 id="o-que-√©-o-liquibase">
  O que √© o Liquibase?
  <a class="heading-link" href="#o-que-%c3%a9-o-liquibase">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Provavelmente voc√™ j√° esteve em um cen√°rio onde era necess√°rio criar uma base de dados nova para preparar um ambiente e quando foi ver era preciso executar diversos scripts SQL com uma quantidade enorme de linhas, ou at√© mesmo criar mais de uma base de dados ao mesmo tempo. Isso pode se tornar uma tarefa muito cansativa. Existe a possibilidade de esquecer de executar aquele script que fica l√° no meio de outros muitos. Definitivamente isso √© bem chato. E em um cen√°rio mais cr√≠tico: changes em produ√ß√£o? Se esse trabalho n√£o √© feito por um DBA, provavelmente ser√° voc√™ o respons√°vel por executar essas a√ß√£o e isso pode ser bem arriscado. Isso sem falar na eventual necessidade de rollback.</p>
<p>Vamos deixar os problemas tradicionais relativos a changes na base de lado por um minuto e come√ßar a pensar simplesmente na possibilidade de versionar os scripts de banco de uma forma parecida como fazemos com o c√≥digo da aplica√ß√£o. Os scripts tamb√©m passariam a ter uma sequencia de execu√ß√£o definida de fato. De quebra ainda seria mais f√°cil fazer rastreabilidade das altera√ß√µes.</p>
<p>O Liquibase veio para solucionar todos esses problemas. Com ele ser√° poss√≠vel versionar as altera√ß√µes do banco, poderemos fazer rollbacks com muito mais facilidade e ainda teremos uma rastreabilidade do que foi executado e quando. Ah. Tamb√©m passaremos a garantia de que n√£o importa quantas vezes o script seja executado, nada quebrar√°. Como? Pela vers√£o u√©. Se ele j√° executou uma vers√£o, n√£o executar√° outra vez aquela mesma vers√£o.</p>
<p>O Liquibase n√£o √© a √∫nica solu√ß√£o do tipo no mercado. Existe tamb√©m outras ferramentas como o Flyway, por exemplo. Por√©m, como estou mais acostumado com o primeiro, nada mais justo que come√ßar por ele.</p>
<p>Ent√£o vamos ao que interessa‚Ä¶</p>
<h2 id="o-b√°sico-antes-de-usar">
  O b√°sico antes de usar
  <a class="heading-link" href="#o-b%c3%a1sico-antes-de-usar">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>O Liquibase d√° suporte a diversas bases de dados. A lista abaixo s√£o os principais DBs suportados.</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7VqRF2BdIlo5uKSTmTqVOg.png" alt="Imagem retirada da p√°gina do Liquibase "></p>
<p>Para criar a estrutura das suas tabelas voc√™ pode fazer de quatro formas: XML, YAML, JSON e SQL. Abaixo est√£o alguns exemplos que eu peguei do pr√≥prio site do Liquibase.</p>
<h2 id="sqlhttpsdocsliquibasecomconceptschangelogssql-formathtml">
  <a href="https://docs.liquibase.com/concepts/changelogs/sql-format.html">SQL</a>
  <a class="heading-link" href="#sqlhttpsdocsliquibasecomconceptschangelogssql-formathtml">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="font-style:italic">--liquibase formatted sql
</span></span></span><span style="display:flex;"><span><span style="font-style:italic">--changeset nvoxland:1
</span></span></span><span style="display:flex;"><span><span style="font-style:italic"></span><span style="font-weight:bold">create</span> <span style="font-weight:bold">table</span> test1 (
</span></span><span style="display:flex;"><span>    id int <span style="font-weight:bold">primary</span> <span style="font-weight:bold">key</span>,
</span></span><span style="display:flex;"><span>    name varchar(255)
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="font-style:italic">--rollback drop table test1;
</span></span></span><span style="display:flex;"><span><span style="font-style:italic">--changeset nvoxland:2
</span></span></span><span style="display:flex;"><span><span style="font-style:italic"></span><span style="font-weight:bold">insert</span> <span style="font-weight:bold">into</span> test1 (id, name) <span style="font-weight:bold">values</span> (1, <span style="">‚Äò</span>name 1<span style="">‚Ä≤</span>);
</span></span><span style="display:flex;"><span><span style="font-weight:bold">insert</span> <span style="font-weight:bold">into</span> test1 (id, name) <span style="font-weight:bold">values</span> (2, <span style="">‚Äò</span>name 2<span style="">‚Ä≤</span>);
</span></span><span style="display:flex;"><span><span style="font-style:italic">--changeset nvoxland:3 dbms:oracle
</span></span></span><span style="display:flex;"><span><span style="font-style:italic"></span><span style="font-weight:bold">create</span> sequence seq_test;
</span></span></code></pre></div><h2 id="xmlhttpwwwliquibaseorgdocumentationxml_formathtml">
  <a href="http://www.liquibase.org/documentation/xml_format.html">XML</a>
  <a class="heading-link" href="#xmlhttpwwwliquibaseorgdocumentationxml_formathtml">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;databaseChangeLog</span>
</span></span><span style="display:flex;"><span>        xmlns=<span style="font-style:italic">&#34;http://www.liquibase.org/xml/ns/dbchangelog&#34;</span>
</span></span><span style="display:flex;"><span>        xmlns:xsi=<span style="font-style:italic">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>        xmlns:ext=<span style="font-style:italic">&#34;http://www.liquibase.org/xml/ns/dbchangelog-ext&#34;</span>
</span></span><span style="display:flex;"><span>        xsi:schemaLocation=<span style="font-style:italic">&#34;http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd
</span></span></span><span style="display:flex;"><span><span style="font-style:italic">        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;preConditions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;runningAs</span> username=<span style="font-style:italic">&#34;liquibase&#34;</span><span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/preConditions&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;changeSet</span> id=<span style="font-style:italic">&#34;1&#34;</span> author=<span style="font-style:italic">&#34;nvoxland&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;createTable</span> tableName=<span style="font-style:italic">&#34;person&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;column</span> name=<span style="font-style:italic">&#34;id&#34;</span> type=<span style="font-style:italic">&#34;int&#34;</span> autoIncrement=<span style="font-style:italic">&#34;true&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&lt;constraints</span> primaryKey=<span style="font-style:italic">&#34;true&#34;</span> nullable=<span style="font-style:italic">&#34;false&#34;</span><span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;/column&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;column</span> name=<span style="font-style:italic">&#34;firstname&#34;</span> type=<span style="font-style:italic">&#34;varchar(50)&#34;</span><span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;column</span> name=<span style="font-style:italic">&#34;lastname&#34;</span> type=<span style="font-style:italic">&#34;varchar(50)&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&lt;constraints</span> nullable=<span style="font-style:italic">&#34;false&#34;</span><span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;/column&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;column</span> name=<span style="font-style:italic">&#34;state&#34;</span> type=<span style="font-style:italic">&#34;char(2)&#34;</span><span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/createTable&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/changeSet&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;changeSet</span> id=<span style="font-style:italic">&#34;2&#34;</span> author=<span style="font-style:italic">&#34;nvoxland&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;addColumn</span> tableName=<span style="font-style:italic">&#34;person&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;column</span> name=<span style="font-style:italic">&#34;username&#34;</span> type=<span style="font-style:italic">&#34;varchar(8)&#34;</span><span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/addColumn&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/changeSet&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;changeSet</span> id=<span style="font-style:italic">&#34;3&#34;</span> author=<span style="font-style:italic">&#34;nvoxland&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;addLookupTable</span>
</span></span><span style="display:flex;"><span>            existingTableName=<span style="font-style:italic">&#34;person&#34;</span> existingColumnName=<span style="font-style:italic">&#34;state&#34;</span>
</span></span><span style="display:flex;"><span>            newTableName=<span style="font-style:italic">&#34;state&#34;</span> newColumnName=<span style="font-style:italic">&#34;id&#34;</span> newColumnDataType=<span style="font-style:italic">&#34;char(2)&#34;</span><span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/changeSet&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/databaseChangeLog&gt;</span>
</span></span></code></pre></div><h2 id="yamlhttpsdocsliquibasecomconceptschangelogsyaml-formathtml">
  <a href="https://docs.liquibase.com/concepts/changelogs/yaml-format.html">Yaml</a>
  <a class="heading-link" href="#yamlhttpsdocsliquibasecomconceptschangelogsyaml-formathtml">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="font-weight:bold">databaseChangeLog</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">preConditions</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">runningAs</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">username</span>: liquibase
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">changeSet</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">id</span>: 1
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">author</span>: nvoxland
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">changes</span>:
</span></span><span style="display:flex;"><span>        - <span style="font-weight:bold">createTable</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">tableName</span>: person
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">columns</span>:
</span></span><span style="display:flex;"><span>              - <span style="font-weight:bold">column</span>:
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">name</span>: id
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">type</span>: int
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">autoIncrement</span>: <span style="font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">constraints</span>:
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">primaryKey</span>: <span style="font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">nullable</span>: <span style="font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>              - <span style="font-weight:bold">column</span>:
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">name</span>: firstname
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">type</span>: varchar(50)
</span></span><span style="display:flex;"><span>              - <span style="font-weight:bold">column</span>:
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">name</span>: lastname
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">type</span>: varchar(50)
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">constraints</span>:
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">nullable</span>: <span style="font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>              - <span style="font-weight:bold">column</span>:
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">name</span>: state
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">type</span>: char(2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">changeSet</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">id</span>: 2
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">author</span>: nvoxland
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">changes</span>:
</span></span><span style="display:flex;"><span>        - <span style="font-weight:bold">addColumn</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">tableName</span>: person
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">columns</span>:
</span></span><span style="display:flex;"><span>              - <span style="font-weight:bold">column</span>:
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">name</span>: username
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">type</span>: varchar(8)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">changeSet</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">id</span>: 3
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">author</span>: nvoxland
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">changes</span>:
</span></span><span style="display:flex;"><span>        - <span style="font-weight:bold">addLookupTable</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">existingTableName</span>: person
</span></span><span style="display:flex;"><span>            existingColumnName:state
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">newTableName</span>: state
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">newColumnName</span>: id
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">newColumnDataType</span>: char(2)
</span></span></code></pre></div><h2 id="jsonhttpwwwliquibaseorgdocumentationjson_formathtml">
  <a href="http://www.liquibase.org/documentation/json_format.html">JSON</a>
  <a class="heading-link" href="#jsonhttpwwwliquibaseorgdocumentationjson_formathtml">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&#34;databaseChangeLog&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&#34;preConditions&#34;</span>: [
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">&#34;runningAs&#34;</span>: {
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">&#34;username&#34;</span>: <span style="font-style:italic">&#34;liquibase&#34;</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&#34;changeSet&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;id&#34;</span>: <span style="font-style:italic">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;author&#34;</span>: <span style="font-style:italic">&#34;nvoxland&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;changes&#34;</span>: [
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">&#34;createTable&#34;</span>: {
</span></span><span style="display:flex;"><span>                            <span style="font-weight:bold">&#34;tableName&#34;</span>: <span style="font-style:italic">&#34;person&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="font-weight:bold">&#34;columns&#34;</span>: [
</span></span><span style="display:flex;"><span>                                {
</span></span><span style="display:flex;"><span>                                    <span style="font-weight:bold">&#34;column&#34;</span>: {
</span></span><span style="display:flex;"><span>                                        <span style="font-weight:bold">&#34;name&#34;</span>: <span style="font-style:italic">&#34;id&#34;</span>,
</span></span><span style="display:flex;"><span>                                        <span style="font-weight:bold">&#34;type&#34;</span>: <span style="font-style:italic">&#34;int&#34;</span>,
</span></span><span style="display:flex;"><span>                                        <span style="font-weight:bold">&#34;autoIncrement&#34;</span>: <span style="font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>                                        <span style="font-weight:bold">&#34;constraints&#34;</span>: {
</span></span><span style="display:flex;"><span>                                            <span style="font-weight:bold">&#34;primaryKey&#34;</span>: <span style="font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>                                            <span style="font-weight:bold">&#34;nullable&#34;</span>: <span style="font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>                                        },
</span></span><span style="display:flex;"><span>                                    }
</span></span><span style="display:flex;"><span>                                },
</span></span><span style="display:flex;"><span>                                {
</span></span><span style="display:flex;"><span>                                    <span style="font-weight:bold">&#34;column&#34;</span>: {
</span></span><span style="display:flex;"><span>                                        <span style="font-weight:bold">&#34;name&#34;</span>: <span style="font-style:italic">&#34;firstname&#34;</span>,
</span></span><span style="display:flex;"><span>                                        <span style="font-weight:bold">&#34;type&#34;</span>: <span style="font-style:italic">&#34;varchar(50)&#34;</span>
</span></span><span style="display:flex;"><span>                                    }
</span></span><span style="display:flex;"><span>                                },
</span></span><span style="display:flex;"><span>                                {
</span></span><span style="display:flex;"><span>                                    <span style="font-weight:bold">&#34;column&#34;</span>: {
</span></span><span style="display:flex;"><span>                                        <span style="font-weight:bold">&#34;name&#34;</span>: <span style="font-style:italic">&#34;lastname&#34;</span>,
</span></span><span style="display:flex;"><span>                                        <span style="font-weight:bold">&#34;type&#34;</span>: <span style="font-style:italic">&#34;varchar(50)&#34;</span>,
</span></span><span style="display:flex;"><span>                                        <span style="font-weight:bold">&#34;constraints&#34;</span>: {
</span></span><span style="display:flex;"><span>                                            <span style="font-weight:bold">&#34;nullable&#34;</span>: <span style="font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>                                        },
</span></span><span style="display:flex;"><span>                                    }
</span></span><span style="display:flex;"><span>                                },
</span></span><span style="display:flex;"><span>                                {
</span></span><span style="display:flex;"><span>                                    <span style="font-weight:bold">&#34;column&#34;</span>: {
</span></span><span style="display:flex;"><span>                                        <span style="font-weight:bold">&#34;name&#34;</span>: <span style="font-style:italic">&#34;state&#34;</span>,
</span></span><span style="display:flex;"><span>                                        <span style="font-weight:bold">&#34;type&#34;</span>: <span style="font-style:italic">&#34;char(2)&#34;</span>
</span></span><span style="display:flex;"><span>                                    }
</span></span><span style="display:flex;"><span>                                }
</span></span><span style="display:flex;"><span>                            ]
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                ]
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&#34;changeSet&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;id&#34;</span>: <span style="font-style:italic">&#34;2&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;author&#34;</span>: <span style="font-style:italic">&#34;nvoxland&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;changes&#34;</span>: [
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">&#34;addColumn&#34;</span>: {
</span></span><span style="display:flex;"><span>                            <span style="font-weight:bold">&#34;tableName&#34;</span>: <span style="font-style:italic">&#34;person&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="font-weight:bold">&#34;columns&#34;</span>: [
</span></span><span style="display:flex;"><span>                                {
</span></span><span style="display:flex;"><span>                                    <span style="font-weight:bold">&#34;column&#34;</span>: {
</span></span><span style="display:flex;"><span>                                        <span style="font-weight:bold">&#34;name&#34;</span>: <span style="font-style:italic">&#34;username&#34;</span>,
</span></span><span style="display:flex;"><span>                                        <span style="font-weight:bold">&#34;type&#34;</span>: <span style="font-style:italic">&#34;varchar(8)&#34;</span>
</span></span><span style="display:flex;"><span>                                    }
</span></span><span style="display:flex;"><span>                                }
</span></span><span style="display:flex;"><span>                           ]
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                ]
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&#34;changeSet&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;id&#34;</span>: <span style="font-style:italic">&#34;3&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;author&#34;</span>: <span style="font-style:italic">&#34;nvoxland&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;changes&#34;</span>: [
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">&#34;addLookupTable&#34;</span>: {
</span></span><span style="display:flex;"><span>                            <span style="font-weight:bold">&#34;existingTableName&#34;</span>: <span style="font-style:italic">&#34;person&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="font-weight:bold">&#34;existingColumnName&#34;</span>:<span style="font-style:italic">&#34;state&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="font-weight:bold">&#34;newTableName&#34;</span>: <span style="font-style:italic">&#34;state&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="font-weight:bold">&#34;newColumnName&#34;</span>: <span style="font-style:italic">&#34;id&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="font-weight:bold">&#34;newColumnDataType&#34;</span>: <span style="font-style:italic">&#34;char(2)&#34;</span>,
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                ]
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Francamente SQL √© minha op√ß√£o favorita. Apesar de j√° ter utilizado tamb√©m o formato YAML e achar bem interessante j√° que n√£o ficamos t√£o amarrados a eventuais pequenas mudan√ßas no SQL de um DB para outro.</p>
<hr>
<h2 id="hands-on">
  Hands-on
  <a class="heading-link" href="#hands-on">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Agora que j√° entendemos um pouco do b√°sico para a utiliza√ß√£o do Liquibase, vamos enfim colocar a m√£o na massa e fazer uma pequena aplica√ß√£o. Para isso faremos uma aplica√ß√£o em <strong>SpringBoot</strong> e <strong>Maven</strong> e utilizaremos o <strong>H2</strong> em mem√≥ria para persistir os dados.</p>
<p>O modelo que utilizaremos ser√° o seguinte.</p>
<p><img src="https://miro.medium.com/v2/resize:fit:738/format:webp/1*WbuDfDesH7Cbz6KQi2sDSg.png" alt="relacionamento"></p>
<blockquote>
<p>N√£o entraremos em muitos detalhes na constru√ß√£o do projeto em si, pois ele n√£o √© o foco nesse momento. Mas no final eu postarei o endere√ßo do Github com o projeto completo.</p>
</blockquote>
<p><strong>Vamos come√ßar criando a estrutura b√°sica do projeto</strong></p>
<ol>
<li>
<p>Criar nossa estrutura do projeto no <a href="https://start.spring.io/">SPRING INITIALIZR</a>.</p>
</li>
<li>
<p>Adicionar as depend√™ncias necess√°rias no <strong>pom.xml</strong></p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-data-jpa<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="font-weight:bold">&lt;groupId&gt;</span>com.h2database<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="font-weight:bold">&lt;artifactId&gt;</span>h2<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="font-weight:bold">&lt;groupId&gt;</span>org.liquibase<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="font-weight:bold">&lt;artifactId&gt;</span>liquibase-core<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start="3">
<li>Adicionando as configura√ß√µes no <strong>application.yml</strong> do SpringBoot</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">h2.console</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">enabled</span>: <span style="font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">path</span>: /h2
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">datasource</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">url</span>: jdbc:h2:mem:responsive-br-versionamento-db-liquibase
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: sa
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">driver-class-name</span>: org.h2.Driver
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">initialize</span>: <span style="font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">jpa</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">show-sql</span>: <span style="font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">properties.hibernate</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">dialect</span>: org.hibernate.dialect.H2Dialect
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">naming-strategy</span>: org.springframework.boot.orm.jpa.hibernate.SpringNamingStrategy
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">hibernate</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">ddl-auto</span>: validate
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">database-platform</span>: org.hibernate.dialect.H2Dialect
</span></span></code></pre></div><p>Com o passo 3 feito, j√° podemos de fato pensar na nossa estrutura do banco de dados. Para esse exemplo escreveremos nosso pr√≥prio SQL e deixaremos o Liquibase respons√°vel por gerenciar essa cria√ß√£o. Vale inclusive notar que o ddl-auto do Hibernate est√° apenas como validate. Portanto ele n√£o far√° nenhum tipo de altera√ß√£o na base e apenas verificar√° se est√° de acordo com o mapeamento feito nas classes de modelos.</p>
<ol start="4">
<li>Criar o changelog e adicionar os SQLs que ser√£o utilizados</li>
</ol>
<p>Ser√° necess√°rio criar dentro de resource a pastas <strong>db/changelog</strong> e <strong>db/changelog/migrations</strong></p>
<p>Dentro de <strong>db/changelog</strong> ser√° criado o um arquivo chamado <strong>db.changelog-master.yaml</strong>. Esse ser√° o arquivo onde ser√° indicado quais arquivos ser√£o utilizados pelo Liquibase como base para cria√ß√£o do BD. Para esse exemplo, ele ficar√° da seguinte forma:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="font-weight:bold">databaseChangeLog</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">include</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">file</span>: migrations/001_schema_inicial.sql
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">relativeToChangelogFile</span>: <span style="font-weight:bold">true</span>
</span></span></code></pre></div><p>E dentro de <strong>db/changelog/migrations</strong> ficar√° os arquivos SQL.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="font-style:italic">--liquibase formatted sql
</span></span></span><span style="display:flex;"><span><span style="font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">--changeset marcopollivier:1
</span></span></span><span style="display:flex;"><span><span style="font-style:italic"></span><span style="font-weight:bold">CREATE</span> <span style="font-weight:bold">TABLE</span> <span style="font-weight:bold">IF</span> <span style="font-weight:bold">NOT</span> <span style="font-weight:bold">EXISTS</span> product (
</span></span><span style="display:flex;"><span> id BIGINT <span style="font-weight:bold">NOT</span> <span style="font-weight:bold">NULL</span> <span style="font-weight:bold">GENERATED</span> <span style="font-weight:bold">BY</span> <span style="font-weight:bold">DEFAULT</span> <span style="font-weight:bold">AS</span> <span style="font-weight:bold">IDENTITY</span> <span style="font-weight:bold">CONSTRAINT</span> product_pkey <span style="font-weight:bold">PRIMARY</span> <span style="font-weight:bold">KEY</span> ,
</span></span><span style="display:flex;"><span> description VARCHAR(255),
</span></span><span style="display:flex;"><span> name VARCHAR(255),
</span></span><span style="display:flex;"><span> parent_product_id BIGINT <span style="font-weight:bold">CONSTRAINT</span> product_parent_fkey <span style="font-weight:bold">references</span> product
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">CREATE</span> <span style="font-weight:bold">TABLE</span> <span style="font-weight:bold">IF</span> <span style="font-weight:bold">NOT</span> <span style="font-weight:bold">EXISTS</span> image (
</span></span><span style="display:flex;"><span> id BIGINT <span style="font-weight:bold">NOT</span> <span style="font-weight:bold">NULL</span> <span style="font-weight:bold">GENERATED</span> <span style="font-weight:bold">BY</span> <span style="font-weight:bold">DEFAULT</span> <span style="font-weight:bold">AS</span> <span style="font-weight:bold">IDENTITY</span> <span style="font-weight:bold">CONSTRAINT</span> image_pkey <span style="font-weight:bold">PRIMARY</span> <span style="font-weight:bold">KEY</span>,
</span></span><span style="display:flex;"><span> <span style="font-weight:bold">type</span> VARCHAR(255),
</span></span><span style="display:flex;"><span> product_id BIGINT <span style="font-weight:bold">CONSTRAINT</span> product_image_fkey <span style="font-weight:bold">REFERENCES</span> product
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">--rollback ALTER TABLE image DROP CONSTRAINT product_image_fkey;
</span></span></span><span style="display:flex;"><span><span style="font-style:italic">--rollback ALTER TABLE product DROP CONSTRAINT product_parent_fkey;
</span></span></span><span style="display:flex;"><span><span style="font-style:italic">--rollback DROP TABLE image;
</span></span></span><span style="display:flex;"><span><span style="font-style:italic">--rollback DROP TABLE product;
</span></span></span></code></pre></div><p>Repare que a primeira linha identifica que esse realmente ser√° um arquivo utilizado pelo Liquibase e refor√ßa que o padr√£o utilizado ser√° o SQL</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="font-style:italic">--liquibase formatted sql
</span></span></span></code></pre></div><p>O segundo pondo de aten√ß√£o √© a configura√ß√£o do changeset. √â nessa linha que ser√° informado quem fez e o n√∫mero da vers√£o dessa change. Essas informa√ß√µes ser√£o armazenadas em tabelas de metadados do Liquibase e esses dados formam uma chave composta de modo que n√£o pode existir dois scripts diferente com a mesma combina√ß√£o de usu√°rio+vers√£o</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="font-style:italic">--changeset marcopollivier:1
</span></span></span></code></pre></div><p>E por ultimo as linhas de rollback. Essa √© uma das coisas mais bacanas da ferramenta como um todo. Como eu posso executar um comando da biblioteca do Liquibase e efetuar o rollback de uma determinada vers√£o, ser√° executado exatamente o que est√° sendo definido nessas linhas.</p>
<p>A estrutura do projeto at√© o momento est√° da seguinte forma</p>
<p><img src="https://miro.medium.com/v2/resize:fit:934/format:webp/1*nVAjyshGg0YEJSe-SgPpkQ.png" alt="ide"></p>
<p>Nesse momento j√° √© poss√≠vel rodar a aplica√ß√£o sem que d√™ erro.</p>
<ol start="5">
<li>Reta final! Agora √© criar as classes de modelo e os Reposit√≥rios.</li>
</ol>
<p>Classe imagem</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="font-weight:bold">package</span> <span style="font-weight:bold">com.github.responsivebr.versionamentobdliquibase.app.domain.model</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">javax.persistence.*</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Entity
</span></span><span style="display:flex;"><span>@Table(name = <span style="font-style:italic">&#34;image&#34;</span>)
</span></span><span style="display:flex;"><span><span style="font-weight:bold">public</span> <span style="font-weight:bold">class</span> <span style="font-weight:bold">Image</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Id
</span></span><span style="display:flex;"><span>    @GeneratedValue(strategy = GenerationType.IDENTITY)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">private</span> Long id;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">private</span> String type;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @ManyToOne(fetch = FetchType.LAZY)
</span></span><span style="display:flex;"><span>    @JoinColumn(name = <span style="font-style:italic">&#34;product_id&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">private</span> Product product;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> Long getId() {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> id;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> <span style="">void</span> setId(Long id) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">this</span>.id = id;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> String getType() {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> type;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> <span style="">void</span> setType(String type) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">this</span>.type = type;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> Product getProduct() {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> product;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> <span style="">void</span> setProduct(Product product) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">this</span>.product = product;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Classe Produto</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="font-weight:bold">package</span> <span style="font-weight:bold">com.github.responsivebr.versionamentobdliquibase.app.domain.model</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">javax.persistence.*</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">java.util.HashSet</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">java.util.Set</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Entity
</span></span><span style="display:flex;"><span>@Table(name = <span style="font-style:italic">&#34;product&#34;</span>)
</span></span><span style="display:flex;"><span><span style="font-weight:bold">public</span> <span style="font-weight:bold">class</span> <span style="font-weight:bold">Product</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Id
</span></span><span style="display:flex;"><span>    @GeneratedValue(strategy = GenerationType.IDENTITY)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">private</span> Long id;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">private</span> String name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">private</span> String description;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @ManyToOne(fetch = FetchType.LAZY)
</span></span><span style="display:flex;"><span>    @JoinColumn(name = <span style="font-style:italic">&#34;parent_product_id&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">private</span> Product parentProduct;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @OneToMany(
</span></span><span style="display:flex;"><span>            mappedBy = <span style="font-style:italic">&#34;parentProduct&#34;</span>,
</span></span><span style="display:flex;"><span>            cascade = CascadeType.ALL,
</span></span><span style="display:flex;"><span>            fetch = FetchType.LAZY)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">private</span> Set&lt;Product&gt; subProducts;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @OneToMany(
</span></span><span style="display:flex;"><span>            mappedBy = <span style="font-style:italic">&#34;product&#34;</span>,
</span></span><span style="display:flex;"><span>            cascade = CascadeType.ALL,
</span></span><span style="display:flex;"><span>            fetch = FetchType.LAZY)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">private</span> Set&lt;Image&gt; images;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> Product() {
</span></span><span style="display:flex;"><span>        subProducts = <span style="font-weight:bold">new</span> HashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>        images = <span style="font-weight:bold">new</span> HashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> Long getId() {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> id;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> <span style="">void</span> setId(Long id) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">this</span>.id = id;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> String getName() {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> name;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> <span style="">void</span> setName(String name) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">this</span>.name = name;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> String getDescription() {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> description;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> <span style="">void</span> setDescription(String description) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">this</span>.description = description;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> Product getParentProduct() {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> parentProduct;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> <span style="">void</span> setParentProduct(Product parentProduct) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">this</span>.parentProduct = parentProduct;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> Set&lt;Product&gt; getSubProducts() {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> subProducts;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> <span style="">void</span> setSubProducts(Set&lt;Product&gt; subProducts) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">this</span>.subProducts = subProducts;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> Set&lt;Image&gt; getImages() {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> images;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> <span style="">void</span> setImages(Set&lt;Image&gt; images) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">this</span>.images = images;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="font-style:italic"></span>    <span style="font-weight:bold">public</span> <span style="">void</span> addSubProduct(Product product) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span>(product != <span style="font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">this</span>.subProducts.add(product);
</span></span><span style="display:flex;"><span>            product.setParentProduct(<span style="font-weight:bold">this</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> <span style="">void</span> addImage(Image image) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span>(image != <span style="font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">this</span>.images.add(image);
</span></span><span style="display:flex;"><span>            image.setProduct(<span style="font-weight:bold">this</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Reposit√≥rio de Imagem</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="font-weight:bold">package</span> <span style="font-weight:bold">com.github.responsivebr.versionamentobdliquibase.app.domain.repository</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">com.github.responsivebr.versionamentobdliquibase.app.domain.model.Image</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.springframework.data.jpa.repository.JpaRepository</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.springframework.stereotype.Repository</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Repository
</span></span><span style="display:flex;"><span><span style="font-weight:bold">public</span> <span style="font-weight:bold">interface</span> <span style="font-weight:bold">ImageRepository</span> <span style="font-weight:bold">extends</span> JpaRepository&lt;Image, Long&gt; {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Reposit√≥rio de Produto</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="font-weight:bold">package</span> <span style="font-weight:bold">com.github.responsivebr.versionamentobdliquibase.app.domain.repository</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">com.github.responsivebr.versionamentobdliquibase.app.domain.model.Product</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.springframework.data.jpa.repository.JpaRepository</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.springframework.stereotype.Repository</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Repository
</span></span><span style="display:flex;"><span><span style="font-weight:bold">public</span> <span style="font-weight:bold">interface</span> <span style="font-weight:bold">ProductRepository</span> <span style="font-weight:bold">extends</span> JpaRepository&lt;Product, Long&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>E por fim, adicionar a anota√ß√£o <strong>EntityScan</strong> no na classe da Aplica√ß√£o</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="font-weight:bold">package</span> <span style="font-weight:bold">com.github.responsivebr.versionamentobdliquibase</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.springframework.boot.SpringApplication</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.springframework.boot.autoconfigure.SpringBootApplication</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.springframework.boot.autoconfigure.domain.EntityScan</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.springframework.data.jpa.convert.threeten.Jsr310JpaConverters</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@SpringBootApplication
</span></span><span style="display:flex;"><span>@EntityScan(basePackageClasses = {Application.class, Jsr310JpaConverters.class})
</span></span><span style="display:flex;"><span><span style="font-weight:bold">public</span> <span style="font-weight:bold">class</span> <span style="font-weight:bold">Application</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="font-weight:bold">public</span> <span style="font-weight:bold">static</span> <span style="">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>      SpringApplication.run(Application.class, args);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>E pronto. A estrutura do banco est√° sendo criada pelo Liquibase e a aplica√ß√£o est√° devidamente mapeada.</p>
<p>Agora o passo final √© criar um teste b√°sico para confirmar que est√° tudo de acordo.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="font-weight:bold">package</span> <span style="font-weight:bold">com.github.responsivebr.versionamentobdliquibase</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">com.github.responsivebr.versionamentobdliquibase.app.domain.model.Image</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">com.github.responsivebr.versionamentobdliquibase.app.domain.model.Product</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">com.github.responsivebr.versionamentobdliquibase.app.domain.repository.ProductRepository</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.junit.Assert</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.junit.Test</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.junit.runner.RunWith</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.springframework.beans.factory.annotation.Autowired</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.springframework.boot.test.context.SpringBootTest</span>;
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">org.springframework.test.context.junit4.SpringRunner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RunWith(SpringRunner.class)
</span></span><span style="display:flex;"><span>@SpringBootTest
</span></span><span style="display:flex;"><span><span style="font-weight:bold">public</span> <span style="font-weight:bold">class</span> <span style="font-weight:bold">ValidationTest</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    ProductRepository productRepository;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">public</span> <span style="">void</span> testApplicationPersistence() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Product product = buildProduct();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Product savedProduct = productRepository.save(product);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Assert.assertNotNull(savedProduct.getId());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Assert.assertNotNull(savedProduct.getImages().stream().findFirst().get().getId());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Assert.assertNotNull(savedProduct.getSubProducts().stream().findFirst().get().getId());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Assert.assertEquals(<span style="font-style:italic">&#34;Default image&#34;</span>, savedProduct.getImages().stream().findFirst().get().getType());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Assert.assertEquals(<span style="font-style:italic">&#34;Child Product&#34;</span>, savedProduct.getSubProducts().stream().findFirst().get().getName());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">private</span> Image buildImage() {
</span></span><span style="display:flex;"><span>        Image im = <span style="font-weight:bold">new</span> Image();
</span></span><span style="display:flex;"><span>        im.setType(<span style="font-style:italic">&#34;Default image&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> im;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">private</span> Product buildChildProduct() {
</span></span><span style="display:flex;"><span>        Product parent = <span style="font-weight:bold">new</span> Product();
</span></span><span style="display:flex;"><span>        parent.setName(<span style="font-style:italic">&#34;Child Product&#34;</span>);
</span></span><span style="display:flex;"><span>        parent.setDescription(<span style="font-style:italic">&#34;This is a child product&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> parent;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">private</span> Product buildProduct() {
</span></span><span style="display:flex;"><span>        Product parent = <span style="font-weight:bold">new</span> Product();
</span></span><span style="display:flex;"><span>        parent.setName(<span style="font-style:italic">&#34;Parent Product&#34;</span>);
</span></span><span style="display:flex;"><span>        parent.setDescription(<span style="font-style:italic">&#34;This is a parent product&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        parent.addImage(buildImage());
</span></span><span style="display:flex;"><span>        parent.addSubProduct(buildChildProduct());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> parent;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Executando o teste, se torna poss√≠vel testar e comprovar que tudo foi criado corretamente e que as informa√ß√µes est√£o sendo persistidas sem maiores problemas.</p>
<hr>
<h2 id="conclus√£o">
  Conclus√£o
  <a class="heading-link" href="#conclus%c3%a3o">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Uma das boas pr√°ticas que j√° est√° no nosso cotidiano do desenvolvimento √© o controle de vers√£o de c√≥digo. Hoje vimos que √© poss√≠vel ter esse mesmo controle nas altera√ß√µes da nossa base de dados utilizando uma ferramenta como o Liquibase. Dessa forma fica mais f√°cil controlarmos qualquer tipo de altera√ß√£o da nossa base de dados, nos proporcionando um pouco mais de seguran√ßa para realizar esse tipo de atividade.</p>
<hr>
<p><a href="https://github.com/marcopollivier/versionamento-db-liquibase">Repositorio Github</a>
<a href="https://www.liquibase.org/">Liquibase</a></p>
<hr>
<p>No pr√≥ximo post vamos aprofundar um pouco mais no Liquibase e ver algumas funcionalidades que ele nos proporciona.</p>
<p>Espero que este post tenha sido verdadeiramente √∫til. Qualquer d√∫vida ou sugest√£o, por favor n√£o hesite em escrever nos coment√°rios.</p>
<p>At√© a pr√≥xima.</p>
  </article>
</section>

  

      </div>

      <footer class="footer">
  <section class="container">
    ¬©
    
      2012 -
    
    2023
     Marco Ollivier 
    ¬∑
    
    Promovido por <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
    
  </section>
</footer>

    </main>

    
      
      <script src="/js/coder.min.9cf2dbf9b6989ef8eae941ffb4231c26d1dc026bca38f1d19fdba50177d8a9ac.js" integrity="sha256-nPLb&#43;baYnvjq6UH/tCMcJtHcAmvKOPHRn9ulAXfYqaw="></script>
    

    

    

    

    

    

    

    

    
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-WKCPJV9"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'GTM-WKCPJV9');
</script>

  </body>

</html>
